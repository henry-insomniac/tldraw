# 30 分钟动手任务清单（@tldraw/store）

目的：用最少插桩验证 Store 的 CRUD→历史→查询/索引→迁移→副作用→atomic 的关键链路。

预备：在示例或脚本里创建最小 schema
```ts
// 记录
interface Book extends BaseRecord<'book'> { title: string; author: string; inStock: boolean }
const Book = createRecordType<Book>('book', { validator: { validate: (r)=>r as Book }, scope:'document' })
  .withDefaultProperties(()=>({ inStock:true }))
// schema
const schema = StoreSchema.create({ book: Book })
const store = new Store({ schema, props:{} })
```

任务 A：CRUD + 历史（5–7 min）
```ts
store.listen((entry)=>console.debug('[hist]', entry.source, entry.changes))
const b1 = Book.create({ title:'1984', author:'Orwell' })
store.put([b1])                    // [hist] user { added:{...} }
store.update(b1.id, b=>({ ...b, title:'Animal Farm' })) // [hist] user { updated:{...} }
store.remove([b1.id])              // [hist] user { removed:{...} }
```

任务 B：索引与表达式（8–10 min）
```ts
const byAuthor = store.query.index('book','author')
react('idx', ()=> console.debug('[idx.size]', byAuthor.get().size))
const orwell = computed('orwell', ()=> byAuthor.get().get('Orwell') ?? new Set())
react('orwell', ()=> console.debug('[orwell]', [...orwell.get()].length))

store.put([ Book.create({ title:'1984', author:'Orwell' }) ]) // 触发 orwell + 索引
```

任务 C：atomic 与 remote 合并（8–10 min）
```ts
store.addHistoryInterceptor((e)=>console.debug('[hist.raw]', e.source, e.changes))
store.atomic(()=>{
  store.put([ Book.create({ title:'A', author:'X' }) ])
  store.put([ Book.create({ title:'B', author:'X' }) ])
}, /*runCallbacks*/true, /*isMergingRemoteChanges*/true) // source=remote
```

任务 D：迁移（5–7 min）
- 给 Book 定义一个简单迁移序列（例如 publishDate→publishedYear），
- `const snap = store.getStoreSnapshot()` → 修改 schema 版本模拟旧数据 → `store.migrateSnapshot(snap)`，验证字段变换。

任务 E：副作用（5–7 min）
```ts
store.sideEffects.registerBeforeDeleteHandler('book', (b)=> b.title!=='Protected')
const p = Book.create({ title:'Protected', author:'X' })
store.put([p])
store.remove([p.id]) // 应该被阻止
```

清理：移除插桩，并将试验代码迁移到单测或 examples。

