# 相机与坐标系（扩展版）

本章系统化拆解 tldraw 的相机与坐标系：单一事实源、坐标换算、缩放/拖动/跟随交互、锁定与约束、性能策略与常见坑位，并附关键代码索引。

## 架构概览（单一事实源 + 原子选项）

- 相机记录（x,y,z）存于 Store，统一通过 `getCamera()` 读取；当处于“跟随用户”时，`getCamera()` 会叠加被跟随者的相机（渲染态合成），而本地相机仍保存在 Store。
  - 代码：packages/editor/src/lib/editor/Editor.ts:2599（读取），:2652（跟随相机计算）
- 相机选项集中在 `_cameraOptions` 原子（锁定/步进/速度/滚轮行为/约束等），高频读取使用 `__unsafe__getWithoutCapture()` 避免不必要的依赖捕获。
  - 代码：packages/editor/src/lib/editor/Editor.ts:2772（定义），:2783（读取），:10275（热路径读取）

## 坐标换算（屏幕 ↔ 页面）

- 屏幕边界：`Instance.screenBounds` 表示画布在浏览器窗口中的位置/尺寸；先将屏幕坐标减去该偏移，再套用相机变换得到页面坐标。
- 输入更新：`_updateInputsFromEvent(info)` 将 DOM 事件点映射到 `inputs.currentPagePoint`（并更新 TLPOINTER，用于协作光标）。
  - 代码：packages/editor/src/lib/editor/Editor.ts:9515（sx/sy 与 camera 的换算）
- 对外 API：`screenToPage(point)`；相反方向亦有对应方法（按需查找）。
  - 代码：packages/editor/src/lib/editor/Editor.ts:3696

## 交互：缩放/拖动/跟随

### 缩放（Zoom）
- 滚轮缩放：`wheel` 分支依据 `wheelBehavior`（trackpad→pan, mouse→zoom）与 Ctrl 键临时翻转；以当前屏幕点为锚缩放（先算新 z，再回推相机平移保持锚点不动）。
  - 代码：packages/editor/src/lib/editor/Editor.ts:10440 起（zoom 分支 :10478–:10493）
- 捏合缩放：`pinch_start` 缓存当时的选区并进入 pinching；`pinch` 以手势中心缩放；`pinch_end` 在未再次捏合时恢复选区。
  - 代码：packages/editor/src/lib/editor/Editor.ts:10278 起（start :10284，缩放 :10322–:10358，end :10386–:10414）
- 步进/速度：由 `zoomSteps/zoomSpeed` 控制缩放平滑程度与步距。

### 拖动（Pan/Drag）
- 空格/中键平移：按下 Space 或中键进入 panning；`pointer_move` 中根据屏幕位移 `/ cz` 平移相机，光标在 grab/grabbing 间切换。
  - 代码：packages/editor/src/lib/editor/Editor.ts:10505–:10514（即时平移），:10596–:10620（键盘辅助）
- 惯性滑动：结束 panning 后按 `pointerVelocity` 触发 `slideCamera`，获得自然的衰减滑动。
  - 代码：packages/editor/src/lib/editor/Editor.ts:10552–:10576

### 跟随（Following）
- 模式：`instanceState.followingUserId` 表示跟随；渲染时通过 `getCamera()` 合成被跟随者相机，本地相机仍在 Store 中维护。
- 用户交互优先：任何缩放/平移发生时会 `stopFollowingUser()`，将当前相机写回 Store 并清空跟随。
  - 代码：packages/editor/src/lib/editor/Editor.ts:3944（stopFollowingUser）

## 锁定与约束

- 相机锁定：`cameraOptions.isLocked` 拦截 wheel/pinch/pan 等交互，适用于演示/只读态。
  - 代码：packages/editor/src/lib/editor/Editor.ts:10440 前后
- 约束/边界：可通过 `cameraOptions.constraints` 限定相机平移/缩放范围（例如不跑出文档），在 `_setCamera/setCamera` 内统一裁剪。

## 性能策略

- 批处理事件：`dispatch` 将 pointer_move/wheel/pinch 合并进同一帧处理，减少状态机抖动。
  - 代码：packages/editor/src/lib/editor/Editor.ts:10177（聚合），:10193（flush）
- 相机移动状态：`_cameraState`（moving/idle）与 cameraMovingTimeoutMs。移动中减少昂贵的可见性/清单更新，停止后再刷新。
  - 代码：packages/editor/src/lib/editor/Editor.ts:4053–:4068
- 热路径无依赖捕获：相机/输入读取常用 `__unsafe__getWithoutCapture()`，防过度订阅。
- UI 像素对齐：DefaultCanvas 缩放时引入小 offset，避免亚像素抖动（尤其 Safari）。
  - 代码：packages/editor/src/lib/components/default-components/DefaultCanvas.tsx（position layers reactor）

## 常见问题与建议

- “跟随 + 输入”冲突：发生本地缩放/平移即中止跟随；若需要“有限交互但继续跟随”，需定制 stopFollowing 逻辑。
- 坐标错位：容器 resize 时要确保 `Instance.screenBounds` 更新，否则 `screenToPage` 偏移（DefaultCanvas 已在 hook 中处理）。
- 过度重渲染：不要在 React 层做几何/裁剪；优先使用 Editor 的缓存 API（`getShapePageTransform/Bounds/MaskedBounds`）。
- 滚轮体验：注意不同设备事件差异，`wheelBehavior` 与 Ctrl 翻转是核心；自定义时需考虑跨平台一致性。

## 关键代码索引

- 相机读取/跟随合并：packages/editor/src/lib/editor/Editor.ts:2599, 2652
- 相机选项原子/读取：packages/editor/src/lib/editor/Editor.ts:2772, 2783, 10275
- 坐标换算（输入更新）：packages/editor/src/lib/editor/Editor.ts:9515
- screen→page：packages/editor/src/lib/editor/Editor.ts:3696
- 平移（pointer_move 中）：packages/editor/src/lib/editor/Editor.ts:10505–:10514
- 滚轮缩放/平移：packages/editor/src/lib/editor/Editor.ts:10440 起
- 捏合缩放：packages/editor/src/lib/editor/Editor.ts:10278 起
- 跟随停止：packages/editor/src/lib/editor/Editor.ts:3944
- 相机移动状态：packages/editor/src/lib/editor/Editor.ts:4053–:4068
- 形状矩阵缓存：packages/editor/src/lib/editor/Editor.ts:4659, 4707

