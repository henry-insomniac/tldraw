# 几何、命中、裁剪与可见性

几何与命中测试
- 统一入口：`getShapeGeometry(shape, opts?)`（packages/editor/src/lib/editor/Editor.ts:4586）。
- 命中测试：`hitTestPoint/bounds/corners` 等由 Geometry2d 提供，Editor 组合矩阵计算进行页面空间判断。

矩阵与边界
- 本地矩阵：`getShapeLocalTransform(shape)`（packages/editor/src/lib/editor/Editor.ts:4636）。
- 页面矩阵：`getShapePageTransform(shape)`（packages/editor/src/lib/editor/Editor.ts:4707）。
- 页面边界：`getShapePageBounds(shape)`（packages/editor/src/lib/editor/Editor.ts:4725）。

裁剪与遮罩
- 祖先裁剪：`_getShapeMaskCache` 收集祖先 clipPath 并相交（packages/editor/src/lib/editor/Editor.ts:4816）。
- CSS clip-path：`_getShapeClipPathCache` 将页面空间多边形反投至局部空间并序列化为 CSS polygon（packages/editor/src/lib/editor/Editor.ts:4737）。
- 蒙版边界：`getShapeMaskedPageBounds`（packages/editor/src/lib/editor/Editor.ts:4860）。

可见性裁剪
- 全局不可见：`notVisibleShapes`（导入派生）
- 动态裁剪：`getCulledShapes()`（packages/editor/src/lib/editor/Editor.ts:5020）
- 显隐策略钩子：`getShapeVisibility(shape, editor)`（构造参数）

设计要点
- 以矩阵缓存（父子组合）与边界缓存减少重复求交与命中成本。
- CSS clip-path 只在需要时更新，避免强制重排；UI 层将 clip-path 同步到前/背景容器两处。
- 可见性决定渲染与命中两条链路，需保持一致，避免“不可见可命中”或相反。

