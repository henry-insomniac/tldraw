# 事件调度序列深挖：dispatch/flush/pinch/wheel/pointer/tick

本文聚焦 Editor 事件从 DOM→Editor→StateNode 的序列化与关键分支（捏合/滚轮/指针/键盘/计时）。

入口与批处理
- `dispatch(info)`：将事件推入 `_pendingEventsForNextTick`（packages/editor/src/lib/editor/Editor.ts:10177）。
  - 对非 pointer_move/wheel/pinch 的事件，立即 `_flushEventsForTick(0)`（:10186）。
- `_flushEventsForTick(elapsed)`：一次性取出队列并逐个 `_flushEventForTick(info)`；若 `elapsed>0`，还会向 RootState 发送 `tick`（packages/editor/src/lib/editor/Editor.ts:10193、:10203）。

逐事件处理 `_flushEventForTick(info)`
- 崩溃早退：若 `getCrashingError()` 非空直接返回（packages/editor/src/lib/editor/Editor.ts:10209–10213）。
- 修饰键容错：Shift/Alt/Ctrl/Meta 松开以 150ms 延迟复位，降低系统层键位事件不同步带来的抖动（:10235–:10265）。
- 指针态同步：非 pointing 时复位 dragging；取 `instanceState/pageState/cameraOptions` 快照（:10269–:10275）。

Pinch（捏合）分支
- 入口：`case 'pinch'`（packages/editor/src/lib/editor/Editor.ts:10278）。
- 锁定检查：`cameraOptions.isLocked` 则忽略（:10279）。
- 更新输入：`_updateInputsFromEvent(info)`（:10281）。
- pinch_start（:10284 起）：
  - 若已在 pinching 则返回（:10285）。
  - 非编辑态时：记录起始缩放 `_pinchStart = getCamera().z`；若尚未缓存，保存当时的选区 IDs（:10287–:10291）。
  - 标记 `_didPinch = true`、`inputs.isPinching = true`，并 `interrupt()` 打断当前工具交互（:10297–:10302）。
- pinch（缩放中）：
  - 计算屏幕中心点（从 instanceState.screenBounds 扣除）并停止相机动画/跟随（:10322–:10335）。
  - 根据 `info.point.z/delta` 调整相机（即时），实现“以手势中心缩放”的体验（:10336–:10358）。
- pinch_end：
  - 复位 `inputs.isPinching`，恢复 pinch 前选区（若期间未再次捏合）（:10386–:10414）。

Wheel（滚轮）分支
- 入口：`case 'wheel'`（:10440）。
- 锁定检查与输入更新；停止相机动画与跟随（:10441–:10456）。
- 设备/偏好决定模式：`wheelBehavior`（trackpad→pan，mouse→zoom），Ctrl 键可反转（:10457–:10477）。
- zoom：基于 dz/dy 归一化计算 zoom，围绕当前屏幕点缩放（:10478–:10493）。
- pan：根据 dx/dy 乘以 `panSpeed/cz` 平移相机（:10499–:10514）。

Pointer（指针）分支
- 入口：`case 'pointer'`（:10588 前），pinching 时忽略。
- 更新输入：`_updateInputsFromEvent(info)`；提取 `isPen/isPenMode`。
- pointer_down：
  - pen 模式下非笔输入直接返回（:10473 上下文）。
  - 处理 spacebar/middle button 拖动画布的进入逻辑，设置光标与 capturedPointerId（详见 10460–10497 段）。
- pointer_move：
  - pen 模式下非笔忽略（:10501）。
  - 若正在 panning 且 pointing，依据屏幕位移平移相机（即时），性能记录“Panning”（:10505–:10514）。
  - 拖拽阈值：`Vec.Dist2(originPagePoint, currentPagePoint) * zoom > dragDistanceSquared/cz`，粗指针与精细指针阈值不同（:10517–:10529）。
- pointer_up：
  - 复位 dragging/pointing；Firefox pointerId 兼容处理（:10533–:10551）。
  - 结束 panning：根据按钮与空格键恢复光标；根据 pointerVelocity 触发 slideCamera 惯性滑动（:10552–:10576）。
  - 触控笔橡皮：结束时恢复上一工具（:10578–:10583）。

Keyboard（键盘）分支（简要）
- 入口：`case 'keyboard'`（:10589）。
- 归一左右修饰键 code；处理 space 键进入/退出 panning；支持箭头键在 panning 中微移相机（:10596–:10620 及后续）。

Tick（节拍）
- `_flushEventsForTick(elapsed)` 末尾调用 `scribbles.tick(elapsed)` 推进涂鸦/临时 UI 衰减（packages/editor/src/lib/editor/Editor.ts:10205）。
- `getCameraState()` 通过 `tick` 监听 cameraMovingTimeoutMs，停止时将渲染清单更新节奏从“运动中”变为“空闲”（:4053–:4068）。

设计要点
- 单帧多事件合并：dispatch 聚合 pointer_move/wheel/pinch，降低工具状态机抖动；其余事件即时 flush 保证响应。
- 相机优先：一旦平移/缩放发生，停止相机动画与跟随，保证本地可控与一致性。
- 修饰键容错：解决不同平台/浏览器键位事件错乱的体验抖动问题。
- 阈值与惯性：拖拽阈值与粗/细指针区分；panning 结束触发相机惯性滑动以提升体验。

延伸阅读：
- 渲染清单逐行解析：`19-渲染清单逐行解析.md`
- 总览剖析：`../Editor.ts-技术架构剖析.md`
