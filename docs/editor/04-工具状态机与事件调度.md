# 工具状态机与事件调度

事件进入 Editor → StateNode（工具状态机）处理 → Store 变更 → React 订阅更新。

事件管线
- 统一调度：`dispatch(info)` → `_flushEventsForTick(elapsed)` → `root.handleEvent(info)`
  - 入口：packages/editor/src/lib/editor/Editor.ts:10177
  - 刷新：packages/editor/src/lib/editor/Editor.ts:10209
  - 逐事件：`_flushEventForTick(info)` packages/editor/src/lib/editor/Editor.ts:10231
  - `tick`：在同帧末尾对当前交互施加时间推进，配合 `scribbles.tick`

修饰键与输入模型
- 修饰键容错：Shift/Alt/Ctrl/Meta 松开延迟 150ms 复位，避免系统层组合键导致的短时错判（10231 附近）。
- 输入镜像：`inputs` 维护屏幕/页面坐标、拖拽/指向/编辑/平移态、修饰键/按钮集等（packages/editor/src/lib/editor/Editor.ts:9467）。
- 同步：`_updateInputsFromEvent(info)` 进行屏幕→页面坐标换算并更新 TLPOINTER 记录（packages/editor/src/lib/editor/Editor.ts:9515）。

手势
- Pointer：`pointer_down/move/up`，根据工具/模式改变选择、创建、拖拽等行为。
- Pinch：`pinch_start/pinch/pinch_end`，触发缩放/平移；开始时保存选区，结束时可恢复（packages/editor/src/lib/editor/Editor.ts:10281 起）。
- Wheel：pan/zoom 模式自动判定；设备/偏好与 Ctrl 键组合切换（packages/editor/src/lib/editor/Editor.ts:10440 起）。

StateNode（工具）
- 根状态：`RootState`，各工具为子状态（可层级化，如 Select.brushing/translating/...）。
- 切换：`setCurrentTool(id, info?)`（packages/editor/src/lib/editor/Editor.ts:1437）、`getCurrentTool()`（:1415）。
- 运行期注入/移除：`setTool/removeTool`（packages/editor/src/lib/editor/Editor.ts:1399/1415 前后）。

设计要点
- 语义事件：React 只负责捕获 DOM 事件，统一转换为 Editor 语义事件后交给 StateNode；避免在 React 中写业务逻辑。
- 同步/中断：相机动画与“跟随用户”在交互开始时被中止；`cancel/interrupt/complete` 提供外部打断接口。
- 严格顺序：`dispatch` 合并同帧事件，提升吞吐并保持工具逻辑一致性。

