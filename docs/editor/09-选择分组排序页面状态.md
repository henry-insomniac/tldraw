# 选择、分组、排序与页面状态

选择（Selection）
- 读取：`getSelectedShapeIds/Shapes`（packages/editor/src/lib/editor/Editor.ts:1626/1636）
- 设置：`setSelectedShapes(ids)`（packages/editor/src/lib/editor/Editor.ts:1653）
- 祖先选择：`isAncestorSelected(shape)`（packages/editor/src/lib/editor/Editor.ts:1675）

分组与层次
- 祖先/后代：`getShapeAncestors/visitDescendants`（packages/editor/src/lib/editor/Editor.ts:4888 起）
- 父子变更触发 `onChildrenChange`（详见 SideEffects 文档）

排序与索引
- 工具函数：`getIndexBetween/getIndicesBetween/getIndexAbove`（来自 @tldraw/utils，Editor 多处使用）
- 重排：`getReorderingShapesChanges`（导入工具，按期望顺序计算变更）

页面状态（PageState）
- 读取/更新：`getCurrentPageState/updateCurrentPageState`（packages/editor/src/lib/editor/Editor.ts:1585/1606）
- 清理：跨页移动/删除后调用 `cleanupInstancePageState` 保证无悬空引用（packages/editor/src/lib/editor/Editor.ts:398 起）

设计要点
- 选区等“视图状态”与文档记录（shape/page）分离，避免简单数据操作引发复杂 UI 迁移。
- 排序使用稀疏浮点索引（IndexKey），支持 O(1) 插入；必要时再 reindex。

