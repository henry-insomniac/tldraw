# 初始化与依赖注入

本文拆解 Editor 的构造与系统接线。类定义：packages/editor/src/lib/editor/Editor.ts:287。

构造核心职责
- 合并配置：`options`（默认见 `defaultTldrawOptions`）、`cameraOptions`、`textOptions`。
- 接入 Store 与 History：`this.store`、`HistoryManager`（撤销/回滚/错误注记）。
- 初始化 Managers：Snap/Text/Font/Tick/EdgeScroll/Focus 等横切模块。
- 状态机装配：`RootState` + 动态注入自定义工具（防覆盖内建工具）。
- 形状/绑定工具注册：`checkShapesAndAddCore`、`checkBindings`，并建立 `styleProps` 与样式 id 唯一性约束。
- SideEffects 订阅：汇聚操作完成与形状/绑定生命周期的后置一致性处理。

关键初始化点（起始行）
- 构造参数与合并：packages/editor/src/lib/editor/Editor.ts:240
- 相机与文本原子：packages/editor/src/lib/editor/Editor.ts:324（`_cameraOptions.set`）、:326（`_textOptions = atom(...)`）
- UserPreferences：packages/editor/src/lib/editor/Editor.ts:334
- Managers 实例化：packages/editor/src/lib/editor/Editor.ts:339（TextManager）、:343（FontManager）、:345（TickManager）、:370（ScribbleManager）
- 工具注入：packages/editor/src/lib/editor/Editor.ts:384（遍历 tools 写入 `root.children`）
- 形状工具注册与样式唯一性：packages/editor/src/lib/editor/Editor.ts:360
- 绑定工具注册：packages/editor/src/lib/editor/Editor.ts:376
- SideEffects 接线：packages/editor/src/lib/editor/Editor.ts:451（operationComplete）、:492（shape.afterChange）、:602（beforeDelete）

设计要点
- 依赖注入提前完成，保证 Editor 对外 API 可即刻调用；细粒度原子（atoms）与缓存（ComputedCache）延迟求值，避免启动开销。
- 工具/形状/绑定均通过构造时注入，运行期间提供 `setTool/removeTool` 以支持热插拔。
- 所有横切能力（吸附/文本/字体/时钟/滚动/焦点）集中在 Managers，降低 Editor 内核复杂度。

